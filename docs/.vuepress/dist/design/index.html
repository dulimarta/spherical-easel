<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Design Document</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.da642629.css" as="style"><link rel="preload" href="/assets/js/app.dbe54ffb.js" as="script"><link rel="preload" href="/assets/js/2.3e5ec5bd.js" as="script"><link rel="preload" href="/assets/js/22.17040f51.js" as="script"><link rel="preload" href="/assets/js/4.6a2b2572.js" as="script"><link rel="prefetch" href="/assets/js/10.4c8b598f.js"><link rel="prefetch" href="/assets/js/11.1a589423.js"><link rel="prefetch" href="/assets/js/12.1f54efe0.js"><link rel="prefetch" href="/assets/js/13.76321926.js"><link rel="prefetch" href="/assets/js/14.33e4e271.js"><link rel="prefetch" href="/assets/js/15.ee1289d9.js"><link rel="prefetch" href="/assets/js/16.f97d6842.js"><link rel="prefetch" href="/assets/js/17.e59560fe.js"><link rel="prefetch" href="/assets/js/18.2feeaa81.js"><link rel="prefetch" href="/assets/js/19.c06a6e66.js"><link rel="prefetch" href="/assets/js/20.96b53416.js"><link rel="prefetch" href="/assets/js/21.b185d405.js"><link rel="prefetch" href="/assets/js/23.4078fbb4.js"><link rel="prefetch" href="/assets/js/24.03ce167b.js"><link rel="prefetch" href="/assets/js/25.20ff476a.js"><link rel="prefetch" href="/assets/js/26.2b1cdbee.js"><link rel="prefetch" href="/assets/js/27.eec4d1c7.js"><link rel="prefetch" href="/assets/js/28.520dfd2b.js"><link rel="prefetch" href="/assets/js/29.c926afc2.js"><link rel="prefetch" href="/assets/js/3.d9ea36d2.js"><link rel="prefetch" href="/assets/js/30.99569cc5.js"><link rel="prefetch" href="/assets/js/31.62618b6d.js"><link rel="prefetch" href="/assets/js/32.c25e95eb.js"><link rel="prefetch" href="/assets/js/33.db07540d.js"><link rel="prefetch" href="/assets/js/34.42293dec.js"><link rel="prefetch" href="/assets/js/35.23061631.js"><link rel="prefetch" href="/assets/js/36.f189b29f.js"><link rel="prefetch" href="/assets/js/37.862150d3.js"><link rel="prefetch" href="/assets/js/38.b43f9653.js"><link rel="prefetch" href="/assets/js/39.ba707d7f.js"><link rel="prefetch" href="/assets/js/40.a1e276aa.js"><link rel="prefetch" href="/assets/js/41.7be17260.js"><link rel="prefetch" href="/assets/js/42.4e07a402.js"><link rel="prefetch" href="/assets/js/43.82cea979.js"><link rel="prefetch" href="/assets/js/44.55298575.js"><link rel="prefetch" href="/assets/js/45.3685f9ee.js"><link rel="prefetch" href="/assets/js/46.623261da.js"><link rel="prefetch" href="/assets/js/47.9f2ad1ed.js"><link rel="prefetch" href="/assets/js/5.075af5cb.js"><link rel="prefetch" href="/assets/js/6.ce2b3219.js"><link rel="prefetch" href="/assets/js/7.e2160bb5.js"><link rel="prefetch" href="/assets/js/8.1ef45a8b.js"><link rel="prefetch" href="/assets/js/9.17ea37ff.js">
    <link rel="stylesheet" href="/assets/css/0.styles.da642629.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spherical-easel-design-document"><a href="#spherical-easel-design-document" class="header-anchor">#</a> Spherical Easel Design Document</h1> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>We have chosen to break apart the code so that we can implement different code design patterns. Many of the different parts are schematically indicated in this image and some of the interactions are described in it. The information flow and code execution starts from the top where the application collects user input and then decides how to process it.</p> <p><img src="/InformationFlowAndCodeExectution.png" alt="An image"></p> <p>To display and organize information for a graphical object (like an ellipse) on the Sphere Canvas requires two different types of methods: those for rendering it to the screen (including the size, color, fill, portion on the front or back, etc.) and those for keeping track of where this object is located on the sphere and how this object interacts with other objects (location, parents or kids of an object, etc.). This distinction is reflected in the organization of the classes and the directory structure. The classes in the <span class="directory">plottables</span> directory (like <span class="class">Ellipse</span>) all pertain to graphical rendering of objects and classes in the <span class="directory">models</span> directory (like <span class="class">SEEllipse</span>) pertain to the location and how the object should respond to changes in location of its parents. We are using something like the <a href="https://en.wikipedia.org/wiki/Facade_pattern" target="_blank" rel="noopener noreferrer">façade design pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> where the front facing graphics are handled by classes in the <span class="directory">plottables</span> directory which mask the more complex (abstract) behaviors handled by classes in the <span class="directory">models</span> directory. We do this so that if a better graphical renderer comes to the attention of the authors we will be able to change to that new renderer (fairly) easily.</p> <h2 id="adding-a-tool"><a href="#adding-a-tool" class="header-anchor">#</a> Adding a tool</h2> <p>Here is an outline of how you can expand Spherical Easel and <a href="/design/addingatooloutline.html">add a tool</a>.</p> <h2 id="models-directory"><a href="#models-directory" class="header-anchor">#</a> Models Directory</h2> <p>Models are the back-end collection of classes that organize and store information about each graphical object on the <a href="/design/#coordinates">ideal unit sphere</a>. Classes in this directory should be independent of the graphical library chosen for rendering the visual appearance of the geometric objects. All classes in this directory starts with the prefix SE. This is to distinguish them from their plottable counterparts. For instance, <span class="class">SECircle</span> in this subdirectory is associated with the class <span class="class">Circle</span> that resides in the <span class="directory">plottables</span> directory. Notice that multiple <span class="class">SENodule</span> classes (the super class of all the classes in this directory) can be associated with the same class in the <span class="directory">plottables</span> directory. For example, the <span class="class">SEThreePointCircle</span> is also associated with the class <span class="class">Circle</span> in the <span class="directory">plottables</span> directory.</p> <p>Each Model class contains a reference (called <span class="variable">ref</span>) to the corresponding graphical object that lives in the plottables subdirectory. There should be no methods/functions or variables that invoke the routines of the rendering/graphical tools (i.e. <span class="package"><a href="https://two.js.org/" target="_blank" rel="noopener noreferrer">two.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span> currently) except <span class="variable">ref</span> the pointer to the rendering class.</p> <p>The files in this directory manage the fixed (abstract) unit sphere location information and the <a href="/design/#data-structure">data structure</a> for these geometric objects. All of the classes in this directory extend <span class="class">SENodules</span>. This gives them access to the following methods and variables:</p> <ul><li><span class="method">registerChild(SENodule)</span> and <span class="method">unRegisterChild()</span>: Methods for adding newly created (or removing old) objects to or from the <a href="/design/#data-structure">data structure</a>.</li> <li><span class="variable">exists</span>: A boolean flag to declare if this SENodule exists or not. For example, if the user intersection two circles (like point $P_6$ in the <a href="/design/#data-structure">data structure</a> below) and then moves the circle apart, the <span class="variable">exists</span> flag switches from true to false, but the <span class="class">SEPoint</span> object is not deleted. This way if the user moves the circle back into positions where the intersection point exists, the point (and all of the objects it depends on) reappear.</li> <li><span class="variable">outOfDate</span>: A boolean flag to indicate that the SENodule is out of date and needs to be updated.</li> <li><span class="method">markKidsOutOfDate()</span>: A recursive methods to mark all descendants (kids, grand kids, etc.) of the current SENodule out of date.</li> <li><span class="variable">showing</span>: A boolean flag to indicate if the user has hidden the object.</li></ul> <p>A typical constructor for a <span class="class">SENodule</span> class is like the one for <span class="class">SECircle</span>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * Create a model SECircle using:
 * @param circ The plottable TwoJS Object associated to this object
 * @param centerPoint The model SEPoint object that is the center of the circle
 * @param circlePoint The model SEPoint object that is on the circle
 */</span>
<span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">circ<span class="token operator">:</span> Circle<span class="token punctuation">,</span> centerPoint<span class="token operator">:</span> SEPoint<span class="token punctuation">,</span> circlePoint<span class="token operator">:</span> SEPoint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> circ<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_centerSEPoint <span class="token operator">=</span> centerPoint<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_circleSEPoint <span class="token operator">=</span> circlePoint<span class="token punctuation">;</span>

  SECircle<span class="token punctuation">.</span><span class="token constant">CIRCLE_COUNT</span><span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">C-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>SECircle<span class="token punctuation">.</span><span class="token constant">CIRCLE_COUNT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>The first argument is the corresponding plottables object (which assigned to the <span class="variable">ref</span> variable) and the rest are the <span class="class">SENodule</span> objects that it depends on (which immediately register the <span class="class">SECircle</span> object being created).</p> <p>There are some abstract methods in <span class="class">SENodules</span> that must be overridden by each class extending it. Those include:</p> <ul><li><span class="method">update()</span>: A typical implementation of this method follows this outline
<ul><li>Check to see if all the parents of this <span class="class">SENodule</span> are not <span class="variable">outOfDate</span>. If any are, then return without doing anything, knowing that this method will be called again on this object because the last line of this method would have to be called on all outOfDate parents.</li> <li>Update the location or other information for this <span class="class">SENodule</span>. For example, if this is an <span class="class">SEIntersectionPoint</span> of two circles, this is where we would recalulate the location of this intersection point.</li> <li>End with the method <span class="method">updateKids()</span> that updates all kids of this <span class="class">SENodule</span>.</li></ul></li> <li><span class="method">isHitAt(Vector)</span>: Takes an input of a location on the unit ideal sphere and decides if that location is close enough to this object that the user would like to select or highlight it.</li></ul> <h3 id="naming-convention"><a href="#naming-convention" class="header-anchor">#</a> Naming Convention</h3> <p>For any variable in a model class, that has an associated setter or getter, the private version starts with an underscore and the setter or getter version doesn't have an underscore. If the variable is an SE object of some type the two letter sequence SE is in the name.</p> <h3 id="object-state"><a href="#object-state" class="header-anchor">#</a> Object State</h3> <p>Every <span class="class">SENodule</span> object has the following boolean properties:</p> <ul><li><p><span class="variable">_exists</span>: A object doesn't exist if any one of its parents don't exist or its geometric definition indicates that it doesn't exist. For example, an intersection point of two circles exists if the two circles cross, but if the user moves the circle far enough apart, the intersection won't exist. In this case the <span class="variable">_exists</span> variable would go from true to false. If the user moves the circle back into position where the two circles intersect, then the <span class="variable">_exists</span> is back to true (and the point is redisplayed). Note that any objects that depend on this intersection are not lost during this process, they merely don't exist and are not displayed while in this state.</p></li> <li><p><span class="variable">_showing</span>: A user can hide or show objects and this variable reflects that state.</p></li> <li><p><span class="variable">_outOfDate</span>: If an object needs to be updated because its parents may have changed, then this flag is set to true.</p></li> <li><p><span class="variable">_selected</span>: If an object is selected it remains glowing until it is unselected. This property is used to indicate to the user which objects have already been selected when multiple objects need to be selected for an operation.</p></li> <li><p><span class="variable">_isUserCreated</span>: (This property applies to only <span class="class">SEIntersectionPoint</span> objects.) Every time you add a one dimensional object all intersections with all other one dimensional objects are created as <span class="class">SEIntersectionPoint</span> objects. See <span class="class">intersectTwoObjects()</span> method in the <span class="class">getters.ts</span> in the <a href="/design/#store">Store</a>. When they are created in this way, the value of <span class="variable">_isUserCreated</span> is false. When this value is false, mousing over an intersection will make it display in the temporary style instead of glowing. If the user actually uses the point in a construction, <span class="variable">_isUserCreated</span> is true and mousing over it will make it glow as usual. See <span class="command">ConvertInterPtToUserCreatedCommand</span>.</p></li></ul> <h2 id="plottables-directory"><a href="#plottables-directory" class="header-anchor">#</a> Plottables Directory</h2> <p>Plottable classes are the front-end collection of classes that organize and display graphical representations of objects on the <a href="/design/#coordinates">ideal unit sphere</a>. Classes in this directory should only receive updates and information from the <span class="class">SENodule</span> classes to which they are associated. While there are over 40 <span class="class">SENodule</span> classes (one for each <a href="/userguide/toolsobjectspanel.html#tools-tab">geometric tool</a>), there are only about 10 graphically rendered objects and each has its own class in the <span class="directory">plottables</span> directory. This <a href="https://docs.google.com/spreadsheets/d/1o0s0l-offb5uPaimqiIyfVzv22wsuXrKBfjXbZHzxl8/edit?usp=sharing" target="_blank" rel="noopener noreferrer">spreadsheet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> contains a list of the <span class="class">SENodule</span> classes and their corresponding <span class="class">Nodule</span> classes. The plottable classes are</p> <ul><li><span class="class">Point</span></li> <li><span class="class">NonFreePoint</span></li> <li><span class="class">Segment</span></li> <li><span class="class">Line</span></li> <li><span class="class">Circle</span></li> <li><span class="class">CircleArc? (part of Circle?)</span></li> <li><span class="class">Ellipse</span></li> <li><span class="class">AngleMarker</span></li> <li><span class="class">Polygon</span></li> <li><span class="class">Text? Label?</span></li> <li><span class="class">ParametricCurve</span></li></ul> <p>Each of these classes is responsible for</p> <ul><li>rendering the visual appearance, including size, color, line style, shading, etc. of the object. This appearance depends on whether the object (or part of the object) is on the front or back of the sphere and the zoom magnification factor.</li> <li>managing the portions of the object that should be displayed on the front and back of the sphere.</li> <li>managing the doppelgänger objects that are displayed to make the object appear to glow (i.e. is selected by the user).</li></ul> <p>Each of these classes extends the <span class="class">Nodule</span> class and this gives them access to the following abstract methods:</p> <ul><li><p><span class="method">addToLayers(layers:Two.Group[])</span>: This method places all of the graphical objects of this object into the appropriate layers so that the display is rendered appropriately. For example, a point on the back of the sphere is not drawn on top of a circle that is on the front of the sphere.</p></li> <li><p><span class="method">removeFromLayers()</span>: This reverses the operation of <span class="method">addToLayers()</span>.</p></li> <li><p><span class="method">adjustSize(factor: number)</span>: This method is called every time the Zoom Magnification Factor is changed (<a href="/design/#zooming-and-panning">see Zooming And Panning for details</a>) and allows us to set the display size of points and linewidth of one-dimensional objects so that more detailed views are possible. That is, zooming the view doesn't result in a very large point that obscures other details.</p></li> <li><p><span class="method">normalDisplay()</span>: Running this method sets the rendering (i.e. actual view) style of the actually displayed object to the style where the object is not selected or highlighted. It doesn't change the style of the object (that is the method <span class="method">stylize(UPDATE)</span>), but is merely a unidirectional switch to set the display to normal. This method will be called many times during a construction.</p></li> <li><p><span class="method">glowingDisplay()</span>: This method is like <span class="method">normalDisplay()</span> except it sets the actual display to a glowing style to indicate that the user has moused over or selected an object. This method will be called many times during a construction. Note: To make an object glow, a second identically-located object is displayed under the original object (<a href="/design/#layers">see Layers</a>), but with a slightly larger size or line width but colored differently. This is why all the graphical variables in each <span class="class">Nodule</span> class have two versions: a glowing version and a regular one. For example, in the <span class="class">Circle</span> the variable <span class="variable">backVertices</span> has an identically located <span class="variable">glowingBackVertices</span> version. The prefix glowing indicates this.</p></li> <li><p><span class="method">stylize(flag: DisplayStyle)</span>: This method allows the application to two things:</p> <ul><li>Set up a style. That is, indicate that the object being created is temporary one or to set up the glowing style. So that when it is actually displayed the correct look and feel is displayed.</li> <li>Change the display style. That is, allow the user to change the an aspect of the display (i.e change a color).</li></ul> <p>The <span class="class">Nodule</span> objects are used in multiple ways indicate by the <span class="variable">DisplayStyle</span> flag. This flag is an <a href="https://www.typescriptlang.org/docs/handbook/enums.html" target="_blank" rel="noopener noreferrer">enum<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that can have the following values:</p> <ul><li>TEMPORARY - This styling used when the object is being created by a <a href="/design/#event-handlers">handler</a> or has not yet been created by the user. For example, when the user mouses over an intersection point that has not yet been used in an arrangement but was automatically calculated. This style is not modifiable by the user. This method will be called only once on a <span class="class">Nodule</span> object.</li> <li>GLOWING - This sets up the style of the glowing objects, so that when an object is set to <span class="method">glowingDisplay()</span> the glowing objects are rendered correctly. This style is not modifiable by the user. This method will be called only once on a <span class="class">Nodule</span> object.</li> <li>DEFAULT - This sets the style of the object back to the defaults. That is, if the user has made some style changes (say a new color) to objects but changes their mind, the application uses this option to revert the objects back to the defaults that were initially used. This style is not modifiable by the user. This method will be called as many times as the user wants to reset the style on a <span class="class">Nodule</span> object.</li> <li>UPDATE - This sets the style of the object to the variables in object. This allows styles to be applied to an object after the user has made a change. For example, if the user selects a line color of blue in the <a href="/userguide/stylepanel.html">Style Panel</a> the variable <span class="variable">strokeColorFront</span> of that particular line is set to this choice and <span class="method">stylize(UPDATE)</span> is used to apply that choice to the graphical object. This method will be called as many times as the user wants to change the style on a <span class="class">Nodule</span> object.</li></ul></li> <li><p><span class="method">setVisible(flag: boolean)</span>: This turns on or off the visibility of the <span class="class">Nodule</span> object.</p></li></ul> <p>Linking a <span class="class">Nodule</span> object and its corresponding <span class="class">SENodule</span> object is typically done as follows:</p> <ol><li>Create the <span class="class">Nodule</span> object (s) with the empty constructor</li> <li>Stylize the newly created plottable object(s).</li> <li>Create the <span class="class">SENodule</span> object using the newly created plottable(s) in the constructor.</li> <li>Set the unit sphere properties (if any) of the <span class="class">SENodule</span> object</li></ol> <p>This is illustrated in this code snippet from <span class="file">PointHandler.ts</span>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// create a new Point</span>
<span class="token keyword">const</span> newPoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Set the display to the default values</span>
newPoint<span class="token punctuation">.</span><span class="token function">stylize</span><span class="token punctuation">(</span>DisplayStyle<span class="token punctuation">.</span>ApplyCurrentVariables<span class="token punctuation">)</span><span class="token punctuation">;</span>
newPoint<span class="token punctuation">.</span><span class="token function">adjustSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vtx<span class="token operator">:</span> SEPointOnOneDimensional <span class="token operator">|</span> SEPoint <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// Create plottable for the Label</span>
<span class="token keyword">const</span> newLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> newSELabel<span class="token operator">:</span> SELabel <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hitSESegments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// The new point will be a point on a segment</span>
  <span class="token comment">// Create the model object for the new point and link them</span>
  vtx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SEPointOnOneDimensional</span><span class="token punctuation">(</span>newPoint<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hitSESegments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vtx<span class="token punctuation">.</span>locationVector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentSphereVector<span class="token punctuation">;</span> <span class="token comment">// snaps location to the closest on the one Dimensional</span>
  newSELabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SELabel</span><span class="token punctuation">(</span>newLabel<span class="token punctuation">,</span> vtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Create and execute the command to create a new point for undo/redo</span>
  <span class="token keyword">new</span> <span class="token class-name">AddPointOnOneDimensionalCommand</span><span class="token punctuation">(</span>
    vtx<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hitSESegments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    newSELabel
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><h3 id="naming-convention-2"><a href="#naming-convention-2" class="header-anchor">#</a> Naming Convention</h3> <p>For any variable in a plottables class the must be set before the plottable can be properly rendered, the private version of it starts with an underscore and the setter/getter version has the same name with out the underscore. If the variable is a vector of some type the last word of the name is Vector.</p> <h2 id="layers"><a href="#layers" class="header-anchor">#</a> Layers</h2> <p>Layers are an integral part of the rendering process. The renderer (currently from the <span class="package"><a href="https://two.js.org/" target="_blank" rel="noopener noreferrer">two.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span> package) needs to draw objects in a sensible way so that all objects on the front (positive Z-coordinate) of the sphere are rendered on top of all objects on the back of the sphere (negative Z-coordinate). This leads to the <span class="variable">background</span> and <span class="variable">foreground</span> prefixes in the <a href="https://www.typescriptlang.org/docs/handbook/enums.html" target="_blank" rel="noopener noreferrer">enum<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> variable <span class="variable">LAYER</span>. However, even objects the front of the sphere need to be rendered in the appropriate order. For example, <span class="variable">foregroundPoints</span> must be rendered on top of the <span class="variable">foreground</span> one-dimensional objects, but under the <span class="variable">foregroundText</span>. All glowing objects must be rendered under their corresponding non-glowing versions, so for every type of object to be displayed there is a second glowing version of that layer.</p> <p>The complete list of values for enum <span class="variable">LAYER</span> each describe the layer that it numbers:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">enum</span> <span class="token constant">LAYER</span> <span class="token punctuation">{</span>
  backgroundAngleMarkersGlowing<span class="token punctuation">,</span>
  backgroundAngleMarkers<span class="token punctuation">,</span>
  backgroundGlowing<span class="token punctuation">,</span>
  background<span class="token punctuation">,</span>
  backgroundPointsGlowing<span class="token punctuation">,</span>
  backgroundPoints<span class="token punctuation">,</span>
  backgroundTextGlowing<span class="token punctuation">,</span>
  backgroundText<span class="token punctuation">,</span>
  midground<span class="token punctuation">,</span>
  foregroundAngleMarkersGlowing<span class="token punctuation">,</span>
  foregroundAngleMarkers<span class="token punctuation">,</span>
  foregroundGlowing<span class="token punctuation">,</span>
  foreground<span class="token punctuation">,</span>
  foregroundPointsGlowing<span class="token punctuation">,</span>
  foregroundPoints<span class="token punctuation">,</span>
  foregroundTextGlowing<span class="token punctuation">,</span>
  foregroundText
<span class="token punctuation">}</span></code></pre></div><p>Each enum value correspond to a <span class="class">Two.Group</span> (i.e. layer) inside the main <span class="variable">twoInstance</span> which is created in <span class="file">SphereFrame.vue</span>. Pointers to these layers are stored in the private <span class="variable">layers</span> variable in <span class="file">SphereFrame.vue</span>. In turn the <span class="variable">layers</span> variable is passed to all <a href="/design/#event-handlers">Event Handlers</a> so that the objects they create can be placed in the appropriate layers. In the following code we can see that after creating the group in the <span class="variable">twoInstance</span>, the pointer is stored in the <span class="variable">layers</span> variable, and the $y$ axis is flipped on all layers except the text layers.</p> <div class="language-vue extra-class"><pre class="language-vue"><code>// Record the text layer number so that the y axis is not flipped for them
const textLayers = [
  LAYER.foregroundText,
  LAYER.backgroundText,
  LAYER.foregroundTextGlowing,
  LAYER.backgroundTextGlowing
].map(Number); // shortcut for .map(x =&gt; Number(x))
for (const layer in LAYER) {
  const layerIdx = Number(layer);
  if (!isNaN(layerIdx)) {
    // Create the layers
    const newLayer = this.twoInstance.makeGroup();
    this.layers.push(newLayer);

    // Don't flip the y-coord of text layers
    if (textLayers.indexOf(layerIdx) &lt; 0) {
      // Not in textLayers
      newLayer.scale = new Two.Vector(1, -1);
    }
  }
}</code></pre></div><h2 id="rendering-objects"><a href="#rendering-objects" class="header-anchor">#</a> Rendering Objects</h2> <p>The unit sphere is a 3-dimensional object that we must project into 2-dimensions to render on the screen. Rather than use a package like <span class="package"><a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">three.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span> in which we could specify an object in 3-dimensions and have the package render it (by choosing a camera location, a light source, near and far planes, etc.), we chose to use a simpler orthographic projection that we could implement ourselves. We chose the $XY$-plane to be the <em>image plane</em> and the $Z$-axis to be the camera axis (with positive $Z$ pointing towards the viewer).
As one of the main goals of this project was to draw simple, clean, and labeled geometric diagrams on both the screen and paper, we chose the package that best supported that goal. The 3-dimensionality and shading of objects produced using <span class="package"><a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">three.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span> made it difficult to render clearly the one-dimensional objects that make up the bulk of our geometric arrangements.</p> <p>As explained above, the classes in the <a href="/design/#models-directory">Models Directory</a> store information about geometric objects on the ideal unit sphere and the classes in the <a href="/design/#plottables-directory">Plottables Directory</a> are responsible for methods to
render the geometric objects to the screen. This process of going from the ideal unit sphere to the screen is handled in stages. The following diagrams helps to organize this process.</p> <v-card elevation="20" data-v-37414a06><div class="tikz" data-v-37414a06></div></v-card> <p>First the unit sphere information is scaled to be on the Default Sphere. The default radius of the sphere (which is the same as the black boundary circle seen in the Default Screen Plane) was arbitrarily fixed at 250 (the default radius is in pixels if the Zoom Magnification Factor is 1) as set in the <span class="file">global-settings.ts</span> file:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>boundaryCircle<span class="token operator">:</span> <span class="token punctuation">{</span>
  radius<span class="token operator">:</span> <span class="token number">250</span> <span class="token comment">/* default radius */</span><span class="token punctuation">,</span>
  numPoints<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
  opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
  color<span class="token operator">:</span> <span class="token string">&quot;hsla(0, 0%, 0%, 1)&quot;</span><span class="token punctuation">,</span>
  lineWidth<span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div><p>To determine the location of a point on the ideal unit sphere in the Default Screen Plane, we first scale its position vector by the default radius, and then orthographically project by simply dropping the $z$ coordinate. The sign of the $z$ coordinate indicates if the point is rendered in a style that indicates that it is on the back of the sphere or the front. This process is used repeatedly to draw one-dimensional geometric objects. In general, the rendering follows this outline:</p> <ol><li>Create a transformation matrix (<span class="class">Matrix4</span>) that maps the object of the correct size in a standard position (say centered at the North Pole) to the current view of the object on the unit ideal sphere. For example, this is how it is done for circles:</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// Create a matrix4 in the three.js package (called transformMatrix) that maps a circle in standard position (i.e. the</span>
<span class="token comment">//  original circle with vertices forming a circle in the plane z=0 of radius SETTINGS.boundaryCircle.radius) onto</span>
<span class="token comment">//  the one in the target desired (updated) position (i.e. the target circle).</span>

<span class="token comment">// First set up the coordinate system of the target circle</span>
<span class="token comment">// The vector to the circle center is ALSO the normal direction of the circle</span>
desiredZAxis<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_centerVector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Any vector perpendicular the desired z axis can be the desired x axis</span>
desiredXAxis
  <span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>_centerVector<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_centerVector<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Use the cross product to create the vector perpendicular to both the desired z and x axis</span>
desiredYAxis<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>desiredZAxis<span class="token punctuation">,</span> desiredXAxis<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set up the local coordinates from for the circle,</span>
<span class="token comment">//  transformMatrix will now map (1,0,0) to the point on the desired x axis a unit from the origin in the positive direction.</span>
transformMatrix<span class="token punctuation">.</span><span class="token function">makeBasis</span><span class="token punctuation">(</span>desiredXAxis<span class="token punctuation">,</span> desiredYAxis<span class="token punctuation">,</span> desiredZAxis<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Now appropriately translate and scale the circle in standard position to the one in the desired location</span>

<span class="token comment">// translate along the Z of the local coordinate frame</span>
<span class="token comment">// The standard circle plane (z=0) is below the plane of the target circle so translate the plane z=0 to the</span>
<span class="token comment">// the target circle plane</span>
<span class="token keyword">const</span> distanceFromOrigin <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_circleRadius<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>tmpMatrix<span class="token punctuation">.</span><span class="token function">makeTranslation</span><span class="token punctuation">(</span>
  <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span>
  distanceFromOrigin <span class="token operator">*</span> <span class="token constant">SETTINGS</span><span class="token punctuation">.</span>boundaryCircle<span class="token punctuation">.</span>radius
<span class="token punctuation">)</span><span class="token punctuation">;</span>
transformMatrix<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tmpMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The target circle is scaled version of the original circle (but now in the plane of the target circle)</span>
<span class="token comment">// so scale XYZ space in the XY directions by the projected radius (z direction by 1)</span>
<span class="token comment">// this will make the original circle (in the plane of the target circle) finally coincide with the target circle</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>tmpMatrix<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectedRadius<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectedRadius<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
transformMatrix<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tmpMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// transformMatrix now maps the original circle to the target circle</span></code></pre></div><ol start="2"><li>Transform a sampling of points on the object in standard position to the current view.</li> <li>Using the steps above, transform the current view points to the Default Screen Plane, keeping track of if they should be rendered in a style for the front or back.</li> <li>Group the points that should be rendered on the front of the sphere into a front path and similarity for the back.</li> <li>Render the front and back paths to the sphere.</li></ol> <p>In general the rendering process is more complex than this. For example, consider the case of a segment that is longer than $\pi$. It may start on the front, continue on the back for a length of $\pi$ and then reappear on the front again. In this case, the set of points that should be rendered to the front (or back) comes in two discrete paths that must be rendered separately. In general, we have tried to avoid creating or deleting any of the vectors that make up an objects so that the number of points used to display an object is constant and vectors can go from being in a front path to a back path to ensure an equitable distribution of vectors tracing out the object.</p> <h2 id="zooming-and-panning"><a href="#zooming-and-panning" class="header-anchor">#</a> Zooming and Panning</h2> <p>Zooming and panning are accomplished using a CSS (affine) transform applied to the <strong>root</strong> SVG object that the renderer produces. Once an object has been <a href="/design/#rendering-objects">rendered on the Default Screen Plane</a>, the CSS transform displays it in the Viewport (see the illustration in the <a href="/design/#rendering-objects">Rendering Objects</a> section) using a Zoom Magnification Factor and a Zoom Translation Vector. (Note: In the case that Zoom Magnification Factor is 1 and the Zoom Translation Vector is $\langle 0, 0 \rangle$ the Viewport is the same as the Default Screen Plane.) There are two ways that the user can zoom and pan.</p> <ol><li>Using a track pad or mouse wheel. These trigger the <span class="method">handleMouseWheelEvent(MouseEvent)</span> method in the <span class="file">SphereFrame.vue</span> file.</li> <li>Using the <a href="/tools/display.html#zoom-pan-and-standard-view">Zooming and Panning Tools</a>. This fires a <span class="string">&quot;zoom-update&quot;</span> <a href="/design/#event-bus">EventBus</a> action.</li></ol> <p>In both cases the new Zoom Magnification Factor and Translation Vector are written to the <a href="/design/#store">Store</a> (triggering a resize of the plottables - outlined below) and the <span class="method">updateView()</span> method in the <span class="file">SphereFrame.vue</span> file (see below) is eventually executed which sets the new CSS Affine Transformation -- which is alway a uniform scaling and translation and never a shear.</p> <div class="language-vue extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-vue"><code>private updateView() {
  // Get the current maginiication factor and translation vector
  const mag = this.store.state.zoomMagnificationFactor;
  const transVector = this.store.state.zoomTranslation;

  // Get the DOM element to apply the transform to
  const el = (this.twoInstance.renderer as any).domElement as HTMLElement;
  // Set the transform
  const mat = `matrix(${mag},0,0,${mag},${transVector[0]},${transVector[1]})`;
  // console.debug(&quot;CSS transform matrix: &quot;, mat);
  el.style.transform = mat;
  // Set the origin of the transform
  const origin = this.canvasSize / 2;
  el.style.transformOrigin = `${origin}px ${origin}px`;
  // What does this do?
  el.style.overflow = &quot;visible&quot;;
  //Now update the display of the arrangment (i.e. make sure the labels are not too far from their associated objects)
  this.store.state.seLabels.forEach((l: SELabel) =&gt; {
    l.update({ mode: UpdateMode.DisplayOnly, stateArray: [] });
  });
}</code></pre></div><p>When we zoom we control the size of the displayed geometric objects so that the text size, stroke width, point size, etc. do not become so large as to obscure other details in the arrangement. To account for the magnification factor in the display, every class in the <a href="/design/#plottables-directory">Plottables Directory</a> (i.e. all <span class="class">Nodule</span> classes) has a method called <span class="method">adjustSize()</span>. This method is called on all plottables through a chain of events that are outlined here.</p> <p>Whenever a new magnification factor is computed the value is written to the <a href="/design/#store">Store</a> with a dispatch command like the one highlighted in this code snippet from <span class="file">PanZoomHandler.ts</span>:</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br></div><pre class="language-ts"><code><span class="token comment">// Set the new magnification factor and the new translation vector in the store</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span><span class="token function">changeZoomFactor</span><span class="token punctuation">(</span>newMagFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span>commit<span class="token punctuation">.</span><span class="token function">setZoomTranslation</span><span class="token punctuation">(</span>newTranslationVector<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>The <span class="string">&quot;changeZoomFactor&quot;</span> <span class="method">dispatch(...)</span> method results in a <span class="method">commit(...)</span> of the magnification factor to the store and fires a <span class="string">&quot;magnification-updated&quot;</span> <a href="/design/#event-bus">Event Bus</a> action.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">changeZoomFactor</span><span class="token punctuation">(</span><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">,</span> mag<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">&quot;setZoomMagnificationFactor&quot;</span><span class="token punctuation">,</span> mag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  EventBus<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token string">&quot;magnification-updated&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> factor<span class="token operator">:</span> mag <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>As the constructor for <span class="file">Easel.vue</span> contains a listener for the <span class="string">&quot;magnification-updated&quot;</span> <a href="/design/#event-bus">EventBus</a> action.</p> <div class="language-vue extra-class"><pre class="language-vue"><code>constructor() {
  super();
  EventBus.listen(&quot;magnification-updated&quot;, this.resizePlottables);
  EventBus.listen(&quot;undo-enabled&quot;, this.setUndoEnabled);
  EventBus.listen(&quot;redo-enabled&quot;, this.setRedoEnabled);
}</code></pre></div><p>this action calls</p> <div class="language-vue extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-vue"><code>resizePlottables(e: any): void {
  const oldFactor = this.store.state.previousZoomMagnificationFactor;
  // Update the current stroke widths in each plottable class
  Line.updateCurrentStrokeWidthForZoom(oldFactor / e.factor);
  Segment.updateCurrentStrokeWidthForZoom(oldFactor / e.factor);
  Circle.updateCurrentStrokeWidthForZoom(oldFactor / e.factor);
  AngleMarker.updateCurrentStrokeWidthForZoom(oldFactor / e.factor);
  Point.updatePointScaleFactorForZoom(oldFactor / e.factor);
  Label.updateTextScaleFactorForZoom(oldFactor / e.factor);

  // Update the size of each nodule in the store
  this.$store.state.seNodules.forEach((p: SENodule) =&gt; {
    p.ref?.adjustSize();
  });
  // The temporary plottables need to be resized too
  this.$store.state.temporaryNodules.forEach((p: Nodule) =&gt; {
    p.adjustSize();
  });
}</code></pre></div><p>which calls <span class="method">adjustSize()</span> on all plottable retrieved from the from the <a href="/design/#store">Store</a>.</p> <h2 id="data-structure"><a href="#data-structure" class="header-anchor">#</a> Data Structure</h2> <p>The geometric objects in any arrangement are associated to an abstract data structure. The data structure is a directed acyclic graph (DAG). The vertices of the graph are the geometric objects and the arrows of the graph point from one object to another, if the location of the second object depends on the location of the first object. For example, suppose the user creates the following geometric arrangement:</p> <ul><li>Four points, $P_1, P_2, P_3, P_4$, on the sphere.</li> <li>A circle, $C_1$, with center point $P_1$ and edge point $P_2$.</li> <li>A circle, $C_2$, with center point $P_3$ and edge point $P_4$.</li> <li>A line segment, $S_1$, from point $P_1$ to new point $P_5$ that is constrained to be on $C_2$.</li> <li>One of the intersection points, $P_6$, of $C_1$ and $C_2$.</li></ul> <p>As the location of first four points created are not constrained by any other geometric objects (except the surface of the sphere, of course), the vertices in the DAG corresponding to these points have no incoming arrows and are called <strong>free points</strong>. Point $P_5$, and any point that is only constrained to be located on any one-dimensional object, is also considered to free. Any object that is free or only depends on free points is considered to be a <strong>free object</strong>. Free objects are individually movable with the <a href="/tools/display.html#move">Move Tool</a>.</p> <p>To determine the rest of the DAG, consider what changes as we move these points. If the user moves $P_1$ then $C_1$ also moves, so there is an arrow in the DAG from the vertex corresponding to $P_1$ to the vertex corresponding to $C_1$. Similarly segment $S_1$ also moves so there is an arrow between the vertices corresponding to those objects. Continuing in this way we obtain the following DAG where the round green circles correspond to free objects (i.e. individually moveable with the <a href="/tools/display.html#move">Move Tool</a>) and the red rectangles correspond to fixed objects (i.e. unmovable with the <a href="/tools/display.html#move">Move Tool</a>):</p> <v-card elevation="20" data-v-37414a06><div class="tikz" data-v-37414a06></div></v-card> <p>The DAG associated to any geometric arrangement is used to determine which objects need to be refreshed when other objects change their location. For example, if point $P_1$ is moved, then only those objects that depend on $P_1$ (i.e. all descendents $C_1$, $P_6$, and $S_1$) need to be refreshed.</p> <p>Notice that this DAG depends on the location of the objects. So for example, if the user moves the points in such a way that the circles that depend on them do not intersect, then the vertex corresponding to $P_6$ doesn't exist in the arrangement and so its corresponding vertex is no longer in the DAG. (Note that any object that is a descendent of an object that doesn't exist also doesn't exist.)</p> <p>The arrows in the the DAG are programmatically declared and organized using the <span class="variable">parents</span> and <span class="variable">kids</span> array found in the <span class="class">SENodule</span> class. For example, the <span class="variable">parents</span> array of $P_6$ would contain pointers to circles $C_1$ and $C_2$ and its <span class="variable">kids</span> array would be empty. The only pointer in the both $C_1$ and $C_2$ <span class="variable">kids</span> array would be one to $P_6$. See the discussion in the <a href="/design/#models-directory">Models Directory</a> for more information about how this structure is used and handled programmatically.</p> <h2 id="user-interface-vue-components-and-views"><a href="#user-interface-vue-components-and-views" class="header-anchor">#</a> User Interface (Vue Components and Views)</h2> <p>Still in development so write up later.</p> <h2 id="event-handlers"><a href="#event-handlers" class="header-anchor">#</a> Event Handlers</h2> <p>The handlers decide how to handle user mouse and keyboard input to implement a particular tool. A handler class is instantiated as a tool.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>selectTool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelectionHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>layers<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>All handlers implement the interface <span class="interface">ToolStrategy</span>:</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br></div><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ToolStrategy</span> <span class="token punctuation">{</span>
  <span class="token function">mouseMoved</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MouseEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">mousePressed</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MouseEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">mouseReleased</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MouseEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">mouseLeave</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MouseEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">deactivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>The <span class="method">activate()</span> and <span class="method">deactivate()</span> methods are run at the eponymous times during the life cycle of the tool. The <span class="method">activate()</span> method processes all the <a href="/tools/edit.html#selection">selected objects</a> and decides whether or not to execute the appropriate tool routines. The <span class="method">deactivate()</span> method clears the appropriate variable in the tool so that they don't interfere with the execution of other tools.</p> <p>Almost all handlers extend <span class="class">Highlighter</span> which itself extends <span class="class">MouseHandler</span> (the exception is <span class="class">PanZoomHandler</span>). This means that almost all handlers have access to the following variables that are computed in the <span class="method">mouseMoved()</span> method.</p> <ul><li><span class="variable">currentSphereVector</span>: This the <span class="class">Vector3</span> location on the ideal unit sphere corresponding to the current mouse location. (Set in <span class="class">MouseHandler</span>)</li> <li><span class="variable">previousSphereVector</span>: This the <span class="class">Vector3</span> location on the ideal unit sphere of corresponding to the previous mouse location. (Set in <span class="class">MouseHandler</span>)</li> <li><span class="variable">currentScreenVector</span>: This the <span class="class">Two.Vector</span> location in the Default Screen Plane of the current mouse location. (Set in <span class="class">MouseHandler</span>)</li> <li><span class="variable">previousScreenVector</span>: This the <span class="class">Two.Vector</span> location in the Default Screen Plane of the previous mouse location. (Set in <span class="class">MouseHandler</span>)</li> <li><span class="variable">isOnSphere</span>: This boolean variable indicates if the current mouse location is inside the boundary circle in the Default Screen Plane (Set in <span class="class">MouseHandler</span>)</li></ul> <p>In addition, the <span class="method">mouseMoved()</span> method (in <span class="class">Highlighter</span>) queries (via the getters) the <a href="/design/#store">Store</a> to find all the nearby objects. The variable <span class="variable">hitNodules</span> is an array of nearby SEObjects that is sorted into the different class like <span class="variable">hitPoints</span>, <span class="variable">hitSegments</span>, <span class="variable">hitLines</span>, etc. all of which are available to the children of <span class="class">Highlighter</span>. It is the job of each handle to highlight/glow all the objects that it can properly interact with.</p> <h3 id="move-handler"><a href="#move-handler" class="header-anchor">#</a> Move Handler</h3> <p>Move handler allows the user to select free objects. (See the discussion in the <a href="/design/#data-structure">Date Structure</a> section for the definition of a free object.) This means that the <span class="method">mousePress()</span> selects the object to move, <span class="method">mouseMoved()</span> does the actual moving, and <span class="method">mouseRelease()</span> records a command group that allows the user to undo the move. Undoing a move is not a straight forward operation and involves more than just returning points to their original positions.</p> <p>For example, if the user moves a line segment from being less than $\pi$ in length to being greater than $\pi$ in length, the endpoints of the segment themselves do not store this information so moving them back to their original positions doesn't undo this move. Another example is moving a circle, with a point on it (<span class="class">PointOnOneDimensional</span>). If the user moves the circle, the point on it moves, by finding the closest point on the circle to the old location. This process is not reversed by merely restoring the centerSEPoint and circleSEPoint to their original locations.</p> <p>Therefore to undo a move, we must store the before and after locations of any object that depends on the moved points including</p> <ul><li>Any free point (including <span class="class">PointOnOneDimensional</span>)</li> <li>The normal vector to the plane containing the line. (If the points on the line are antipodal, moving the line changes only the normal vector)</li> <li>The segment normal vector and arcLength. (If the points on the line segment are antipodal, moving the line segment changes only the normal vector and as discussed above, the arcLength is not captured by the points.)</li></ul> <p>Note that in the process of undoing the locations of the parent points of circles, line segments and lines are restored first, so we don't need to store the locations of the points that help define lines or line segments. Also circles are completely determined by the center and circle points so we don't have to store any information about them.</p> <p>To help store the information necessary for undoing a move we use the <span class="method">update(beforeMoveState)</span> method where</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">private</span> beforeMoveState<span class="token operator">:</span> UpdateStateType <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> UpdateMode<span class="token punctuation">.</span>RecordStateForDelete<span class="token punctuation">,</span>
  stateArray<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> afterMoveState<span class="token operator">:</span> UpdateStateType <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> UpdateMode<span class="token punctuation">.</span>RecordStateForDelete<span class="token punctuation">,</span>
  stateArray<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div><p>This allows us use the <span class="method">update</span> method to update the <span class="variable">stateArray</span> to record any information that is necessary to restore the state of the object being updated. For example, on <span class="class">SEPoint</span> and <span class="class">SEPointOnOneDimensional</span> we have</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// Create a point state for a Move or delete if necessary</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  state<span class="token punctuation">.</span>mode <span class="token operator">==</span> UpdateMode<span class="token punctuation">.</span>RecordStateForDelete <span class="token operator">||</span>
  state<span class="token punctuation">.</span>mode <span class="token operator">==</span> UpdateMode<span class="token punctuation">.</span>RecordStateForMove
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//  Store the coordinate values of the vector and not the pointer to the vector.</span>
  <span class="token keyword">const</span> pointState<span class="token operator">:</span> PointState <span class="token operator">=</span> <span class="token punctuation">{</span>
    kind<span class="token operator">:</span> <span class="token string">&quot;point&quot;</span><span class="token punctuation">,</span>
    locationVectorX<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_locationVector<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
    locationVectorY<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_locationVector<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
    locationVectorZ<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_locationVector<span class="token punctuation">.</span>z<span class="token punctuation">,</span>
    object<span class="token operator">:</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>stateArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pointState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>This stores the location of the point and not a pointer to the location which would not change during the move! Note that the <span class="method">update</span> method does a topological sort on the directed acyclic graph <a href="/design/#data-structure">Data Structure</a> (but <em>only</em> if the <span class="class">markKidsOutOfDate()</span> method is called first on the object) so the parents of an object are updated before the object itself. Thus the point parents of a one dimensional object are correctly updated before the one ddimensional object itself. Therefore it is not necessary to store any information about the object that is not captured by the parent points and will be restored with a <span class="method">update</span> display only method call like</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">this</span><span class="token punctuation">.</span>moveTarget<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mode<span class="token operator">:</span> UpdateMode<span class="token punctuation">.</span>DisplayOnly<span class="token punctuation">,</span>
  stateArray<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>Hence nothing is stored in the <span class="variable">stateArray</span> for <span class="class">SECircle</span> or <span class="class">SEIntersectionPoint</span> classes. Once the before and after <span class="variable">stateArray</span> has been created, the <span class="class">MoveHandler</span> creates a command group to store all the move points, lines and segments commands. The <span class="command">MovePointCommand</span>, <span class="command">MoveLineCommand</span>, and <span class="command">MoveSegmentCommand</span> classes issue mutations
to the store which then uses <a href="/design/#visitor-and-event-bus-actions">Visitors</a> to actually change the location of points, normal vectors of lines and line segments, and arc length of line segments. The <span class="type">ObjectSaveState</span> type and the interfaces like <span class="interface">LineSaveState</span>, <span class="interface">SegmentSaveState</span>, <span class="interface">PointSaveState</span> in the <span class="directory">types</span> directory give an idea of the information that must be stored in order to undo a <span class="method">move</span></p> <h3 id="delete-handler"><a href="#delete-handler" class="header-anchor">#</a> Delete Handler</h3> <h3 id="other-handlers"><a href="#other-handlers" class="header-anchor">#</a> Other Handlers</h3> <p><a href="/design/handlers/edit.html">Here are details about the implementation of some of the Handlers</a></p> <h2 id="commands"><a href="#commands" class="header-anchor">#</a> Commands</h2> <p>We record each change in the application using a <span class="class">Command</span> object. This allows use to implement a <a href="https://en.wikipedia.org/wiki/Command_pattern" target="_blank" rel="noopener noreferrer">Command Design Pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This pattern allows us to easily implement the <a href="/tools/edit.html#undo-redo">Undo and Redo Tool</a> and ultimately the Load and Save features of the application. Every user action that changes the state of the application is implemented by a <span class="class">Command</span> object.</p> <p>The <span class="class">Command</span> class contains several static variables including</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">static</span> commandHistory<span class="token operator">:</span> Command<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// stack of executed commands</span>
<span class="token keyword">static</span> redoHistory<span class="token operator">:</span> Command<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// stack of undone commands</span></code></pre></div><p>The <span class="variable">commandHistory</span> array stores a stack of commands that are used to get from the initial application state to the current state of the application. The <span class="variable">redoHistory</span> stores a stack of the latest commands that have been redone. These arrays are managed by two static methods:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">static</span> <span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Command<span class="token punctuation">.</span>commandHistory<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// Pop the last command from the history stack</span>
  <span class="token keyword">const</span> lastAction<span class="token operator">:</span> Command <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> Command<span class="token punctuation">.</span>commandHistory<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Run is restore state logic</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Command<span class="token punctuation">.</span>redoHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lastAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastAction<span class="token punctuation">.</span><span class="token function">restoreState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Update the free points to update the display so that individual command and visitors do</span>
  <span class="token comment">// not have to update the display in the middle of undoing or redoing a command (this middle stuff causes</span>
  <span class="token comment">// problems with the move *redo*)</span>
  Command<span class="token punctuation">.</span>store<span class="token punctuation">.</span>commit<span class="token punctuation">.</span><span class="token function">updateDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  EventBus<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token string">&quot;undo-enabled&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> Command<span class="token punctuation">.</span>commandHistory<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  EventBus<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token string">&quot;redo-enabled&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> Command<span class="token punctuation">.</span>redoHistory<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>and</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">static</span> <span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Command<span class="token punctuation">.</span>redoHistory<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> nextAction <span class="token operator">=</span> Command<span class="token punctuation">.</span>redoHistory<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextAction<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Update the free points to update the display so that individual command and visitors do</span>
  <span class="token comment">// not have to update the display in the middle of undoing or redoing a command (this middle stuff causes</span>
  <span class="token comment">// problems with the move *redo*)</span>
  Command<span class="token punctuation">.</span>store<span class="token punctuation">.</span>commit<span class="token punctuation">.</span><span class="token function">updateDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>Each instance of the <span class="class">Command</span> class has access to the following methods:</p> <ul><li><span class="method">execute()</span>:
<ul><li>Puts the command instance in the <span class="variable">commandHistory</span> stack</li> <li>Forces the command instance to save necessary data to restore later (via <span class="method">saveState()</span>)</li> <li>Forces the command instance to perform the actual action of instance command (via <span class="method">do()</span>)</li></ul></li> <li><span class="method">push()</span>:
<ul><li>Does the same thing as <span class="method">execute()</span> except for actually preforming the command.</li> <li>This is used for <a href="/design/handlers/display.html#zoom-pan-and-standard-view">Zooming and Panning</a> which are events that are executed directly based on immediate user input and only when undone or redone are executed by a command instance.</li></ul></li></ul> <p>All Child classes of Command must implement the following abstract methods</p> <ul><li><span class="method">restoreState()</span>: Perform necessary action to restore the app state. The operation(s) implemented in here are usually opposite of the operation(s) implemented in <span class="method">do()</span>.</li> <li><span class="method">saveState()</span>: Save require information to restore the app state</li> <li><span class="method">do()</span>: Perform necessary action to alter the app state</li></ul> <p>For example, to add a point to the state of the application, the <a href="/design/handlers/basic.html#point">PointHandler</a> gathers mouse input and creates the <a href="/design/#plottables-directory">linked <span class="class">Point</span> and <span class="class">SEPoint</span> objects</a>. Then it creates a <span class="class">AddPointCommand</span> object using the <span class="class">SEPoint</span> object in the constructor. This code snippet from <span class="file">AddPointCommand.ts</span> shows this</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AddPointCommand</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> sePoint<span class="token operator">:</span> SEPoint<span class="token punctuation">;</span>
  <span class="token keyword">private</span> seLabel<span class="token operator">:</span> SELabel<span class="token punctuation">;</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">sePoint<span class="token operator">:</span> SEPoint<span class="token punctuation">,</span> seLabel<span class="token operator">:</span> SELabel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sePoint <span class="token operator">=</span> sePoint<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>seLabel <span class="token operator">=</span> seLabel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    Command<span class="token punctuation">.</span>store<span class="token punctuation">.</span>commit<span class="token punctuation">.</span><span class="token function">addLabel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">.</span><span class="token function">registerChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Command<span class="token punctuation">.</span>store<span class="token punctuation">.</span>commit<span class="token punctuation">.</span><span class="token function">addPoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Thanks to Will for suggesting the following magic line</span>
    <span class="token comment">// that makes the objects show up correctly on the canvas</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      mode<span class="token operator">:</span> UpdateMode<span class="token punctuation">.</span>DisplayOnly<span class="token punctuation">,</span>
      stateArray<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">saveState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">restoreState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    Command<span class="token punctuation">.</span>store<span class="token punctuation">.</span>commit<span class="token punctuation">.</span><span class="token function">removeLabel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seLabel<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">.</span><span class="token function">unregisterChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Command<span class="token punctuation">.</span>store<span class="token punctuation">.</span>commit<span class="token punctuation">.</span><span class="token function">removePoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">toOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">.</span>showing<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;AddPoint&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">/* arg-1 */</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token comment">/* arg-2 */</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">.</span>locationVector<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/* arg-3 */</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sePoint<span class="token punctuation">.</span>showing<span class="token punctuation">,</span>
        <span class="token comment">/* arg-4 */</span> <span class="token keyword">this</span><span class="token punctuation">.</span>seLabel<span class="token punctuation">.</span>name
      <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token string">&quot;None&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">parse</span><span class="token punctuation">(</span>command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> objMap<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> SENodule<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Command <span class="token punctuation">{</span>
    <span class="token comment">// console.log(&quot;Parsing&quot;, command);</span>
    <span class="token keyword">const</span> tokens <span class="token operator">=</span> command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    location<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// convert to Number</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> point<span class="token punctuation">,</span> label <span class="token punctuation">}</span> <span class="token operator">=</span> Command<span class="token punctuation">.</span><span class="token function">makePointAndLabel</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    objMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
    objMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>
    point<span class="token punctuation">.</span>showing <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">;</span>
    label<span class="token punctuation">.</span>showing <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AddPointCommand</span><span class="token punctuation">(</span>point<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>The <span class="method">do()</span> and <span class="method">restoreState()</span> methods uses the <span class="string">&quot;addPoint&quot;</span> and <span class="string">&quot;removePoint&quot;</span> mutations of the application state found in the <a href="/design/#store">Store</a>. The <span class="string">&quot;addPoint&quot;</span> mutation is implemented in the <a href="/design/#store">Store</a> as follows.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">addPoint</span><span class="token punctuation">(</span>state<span class="token operator">:</span> AppState<span class="token punctuation">,</span> point<span class="token operator">:</span> SEPoint<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>sePoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>seNodules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
  point<span class="token punctuation">.</span>ref<span class="token punctuation">.</span><span class="token function">addToLayers</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>layers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div><p>This simply pushes the <span class="class">SEPoint</span> into the appropriate arrays in the store and then adds the corresponding plottables objects to the layers in the store. (TODO: Why does it do this?)</p> <p>When the user performs a sequence of changes to the app, sometimes we do not want each individual change to be undone. For example, if the Mouse Wheel or <a href="/tools/display.html#zoom-pan-and-standard-view">Zooming and Panning Tool</a> is used to <a href="/design/#zooming-and-panning">zoom or pan</a>, they may execute thirty or forty small zooms and undoing a large number of small zooms is very tedious. In this case we only push only one Command onto the stack: one that takes the starting view and transforms it to final view. In this case the entire zooming or panning operation is undone with one <span class="method">undo()</span> command. However, this is not always possible and sometimes we use a <span class="class">CommandGroup</span> object to group a sequence of <span class="class">Command</span> objects together, each of which needs to be undone separately, but can be executed as batch.</p> <p>For example, when creating a circle the user may create a new center point, new circle point, and finally a new circle depending on both of these objects. In the <span class="file">CircleHandler.ts</span> file the <span class="method">makeCircle()</span> method starts creating a <span class="class">CommandGroup</span> object</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> circleGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>and then creates (and styles) a new circle <span class="class">Point</span> object which is linked to a new <span class="class">SEPoint</span> object and is finally added to the circleGroup command.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> newCenterPoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Set the display to the default values</span>
newCenterPoint<span class="token punctuation">.</span><span class="token function">stylize</span><span class="token punctuation">(</span>DisplayStyle<span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Set up the glowing display</span>
newCenterPoint<span class="token punctuation">.</span><span class="token function">stylize</span><span class="token punctuation">(</span>DisplayStyle<span class="token punctuation">.</span><span class="token constant">GLOWING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newSECenterPoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SEPoint</span><span class="token punctuation">(</span>newCenterPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
newSECenterPoint<span class="token punctuation">.</span>vectorPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>centerVector<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>centerSEPoint <span class="token operator">=</span> newSECenterPoint<span class="token punctuation">;</span>
circleGroup<span class="token punctuation">.</span><span class="token function">addCommand</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AddPointCommand</span><span class="token punctuation">(</span>newSECenterPoint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Finally, after a similar operation for the circle <span class="class">Point</span>, a new <span class="class">SECircle</span> is added to the command group</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> newSECircle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SECircle</span><span class="token punctuation">(</span>
  newCircle<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>centerSEPoint<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>circleSEPoint
<span class="token punctuation">)</span><span class="token punctuation">;</span>

circleGroup<span class="token punctuation">.</span><span class="token function">addCommand</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AddCircleCommand</span><span class="token punctuation">(</span>newSECircle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>and finally the <span class="class">CommandGroup</span> object is executed</p> <div class="language-ts extra-class"><pre class="language-ts"><code>circleGroup<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="store"><a href="#store" class="header-anchor">#</a> Store</h2> <p>This application uses a <a href="https://vuex.vuejs.org/" target="_blank" rel="noopener noreferrer">Vuex Store<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to implement a <a href="https://en.wikipedia.org/wiki/State_management" target="_blank" rel="noopener noreferrer">State Management Pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This serves as single place to record the state of the app and to change (mutate) that state in predictable ways. It is a repository for all the important variables in the application that can be accessed (<span class="file">getters.ts</span>) and mutated (<span class="file">mutations.ts</span>) by all components of the app. The Store keeps a list of those variables and the initial state is</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> initialState<span class="token operator">:</span> AppState <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// AppState is a type defined in @/types/index.ts</span>
  sphereRadius<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// Is this needed? TODO: remove?</span>
  actionMode<span class="token operator">:</span> <span class="token string">&quot;rotate&quot;</span><span class="token punctuation">,</span> <span class="token comment">// The action mode of the Sphere Canvas</span>
  previousActionMode<span class="token operator">:</span> <span class="token string">&quot;rotate&quot;</span><span class="token punctuation">,</span> <span class="token comment">// The previous action mode</span>
  activeToolName<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">// The active tool for handling user mouse input</span>
  previousActiveToolName<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">// The active tool for handling user mouse input</span>
  zoomMagnificationFactor<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// The CSSTransform magnification factor</span>
  previousZoomMagnificationFactor<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// The previous CSSTransform magnification factor</span>
  zoomTranslation<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// The CSSTransform translation vector</span>
  canvasWidth<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//A temporary canvas width;</span>
  seNodules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of all SENodules</span>
  selections<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of selected SENodules</span>
  layers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of Two.Group pointer to the layers in the twoInstance</span>
  sePoints<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of all SEPoints</span>
  seLines<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of all SELines</span>
  seSegments<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of all SESegments</span>
  seCircles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of all SECircles</span>
  seAngleMarkers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of all SEAngleMarkers</span>
  seLabels<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of all SELabels</span>
  temporaryNodules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// An array of all Nodules that are temporary - created by the handlers.</span>
  intersections<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// measurements: [],</span>
  expressions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  initialStyleStates<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  defaultStyleStates<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  initialBackStyleContrast<span class="token operator">:</span> <span class="token constant">SETTINGS</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>backStyleContrast<span class="token punctuation">,</span>
  useLabelMode<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  inverseTotalRotationMatrix<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//initially the identity. The composition of all the inverses of the rotation matrices applied to the sphere</span>
  svgCanvas<span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div><p>In the <a href="/design/#zooming-and-panning">Zooming and Panning</a> section, the reader might have noticed that the Zoom Translation Vector is written to the <a href="/design/#store">Store</a> with a <span class="method">commit(...)</span> method and the Zoom Magnification Factor is written with a <span class="method">dispatch(...)</span> method. This is because the the <span class="method">commit(...)</span> operation is a synchronous one and the <span class="method">dispatch</span> operation is an asynchronous one. The setting of the translation vector is immediately completed as a mutation of the store, but updating the magnification factor triggers an <a href="/design/#zooming-and-panning">update of all the plottable objects</a> which shouldn't interrupt the programmatic control flow and can happen asynchronously.</p> <h2 id="visitor-and-event-bus-actions"><a href="#visitor-and-event-bus-actions" class="header-anchor">#</a> Visitor and Event Bus Actions</h2> <p>The <span class="class">Visitor</span> class allows one class access to another class's private variables in a controlled way. <span class="class">EventBus</span> actions allow non-Vue components to communicate with Vue components in an asynchronous way. For example, the <a href="/tools/display.html#rotation">Rotation Tool</a> uses both of these classes in crucial way.</p> <p>The <a href="/design/handlers/display.html#rotation">Rotation Handler</a> uses the user mouse input to compute a Change In Position Rotation Matrix that maps the Unit Ideal Sphere to itself (see the illustration in the <a href="/design/#rendering-objects">Rendering Objects</a> section). This fires a <span class="string">&quot;sphere-rotate&quot;</span> <a href="/design/#event-bus">EventBus</a> action as shown in this snippet from <span class="file">RotateHandler.ts</span>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>EventBus<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token string">&quot;sphere-rotate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transform<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>changeInPositionRotationMatrix
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>The <span class="string">&quot;sphere-rotate&quot;</span> <a href="/design/#event-bus">EventBus</a> listener is in <span class="file">SphereFrame.vue</span>. Notice how an events outside of the Vue Component (in the handler) is now triggering an event in a Vue Component. This listener calls</p> <div class="language-vue extra-class"><pre class="language-vue"><code>handleSphereRotation(e: unknown): void {
  this.store.commit.rotateSphere((e as any).transform);
}</code></pre></div><p>The <span class="string">&quot;rotateSphere&quot;</span> mutation of the application state is as follows</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">rotateSphere</span><span class="token punctuation">(</span>state<span class="token operator">:</span> AppState<span class="token punctuation">,</span> rotationMat<span class="token operator">:</span> Matrix4<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// Update the inverseTotalRotationMatrix. We have a new rotationMat which is transforming by</span>
  <span class="token comment">//   rotationMat*oldTotalRotationMatrix * VEC</span>
  <span class="token comment">// so to undo that action we find the inverse which is</span>
  <span class="token comment">//  inverseTotalRotationMatrix*(inverse of rotationMat)</span>
  tmpMatrix<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>rotationMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>inverseTotalRotationMatrix<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>tmpMatrix<span class="token punctuation">.</span><span class="token function">getInverse</span><span class="token punctuation">(</span>tmpMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rotationVisitor<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span>rotationMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// apply the rotation to the line, segments, labels, then points.</span>
  state<span class="token punctuation">.</span>seLines<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m<span class="token operator">:</span> SELine</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>rotationVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Does no updating of the display</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>seSegments<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token operator">:</span> SESegment</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>rotationVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Does no updating of the display</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>seLabels<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">l<span class="token operator">:</span> SELabel</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    l<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>rotationVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Does no updating of the display</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>sePoints<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token operator">:</span> SEPoint</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    p<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>rotationVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Does no updating of the display</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// now do the update of the free points so that display is correct</span>
  state<span class="token punctuation">.</span>sePoints<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token operator">:</span> SEPoint</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">isFreeToMove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      p<span class="token punctuation">.</span><span class="token function">markKidsOutOfDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// so this does a topological sort and update is only executed once on each point</span>
      p<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> UpdateMode<span class="token punctuation">.</span>DisplayOnly<span class="token punctuation">,</span> stateArray<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div><p>Notice that this creates a <span class="class">RotationVisitor</span> based on the Change In Position Rotation Matrix and that is applied to all SEPoint via this snippet from <span class="file">RotationVisitor.ts</span>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">actionOnPoint</span><span class="token punctuation">(</span>p<span class="token operator">:</span> SEPoint<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tmpVector<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>locationVector<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Copy the old vector location of the SEPoint</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tmpVector<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Apply the matrix</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">SEPointOnOneDimensional</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    p<span class="token punctuation">.</span><span class="token function">pointDirectLocationSetter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tmpVector<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// use the direct setter because the parent might be out of date.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    p<span class="token punctuation">.</span>locationVector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tmpVector<span class="token punctuation">;</span> <span class="token comment">// Set the new position vector</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>The <span class="class">RotationVisitor</span> merely updates all other <span class="class">SENodule</span> objects. Notice how the sequence of triggered event is now outside of the Vue Components again, but has been accessed in the Store along the way. Also notice how the <span class="class">RotationVisitor</span> marks the kids of each point out of date before called the <span class="method">update</span> method.</p> <h2 id="stylizing-objects"><a href="#stylizing-objects" class="header-anchor">#</a> Stylizing Objects</h2> <p>When the user opens the <a href="/userguide/stylepanel.html">Style Panel</a> a set of options (in the form of four expansion panels: Basic, Foreground, Background, and Advanced) appears on the right side of the canvas, the <a href="/userguide/toolsobjectspanel.html">Tools and Object Panel</a> is minimized, the active tool is set to the <span class="tool">Selection</span> tool, and the undo and redo buttons are disabled. This is because the user should only be styling objects and not creating new ones (and each option on the style panel has an <span class="button">Undo</span> button).</p> <h3 id="fore-and-back-ground-panels"><a href="#fore-and-back-ground-panels" class="header-anchor">#</a> Fore- and Back-ground Panels</h3> <p>The user can select items to style before entering the Styling Mode (the mode where the Style Panel is open and the others are minimizied). The selected items are imported in the <span class="method">mount()</span> and passed to the <span class="method">OnSelectionChange()</span> method. This method is run when ever there is a change in the selection</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Watch</span><span class="token punctuation">(</span><span class="token string">&quot;selections&quot;</span><span class="token punctuation">)</span>
  <span class="token function">onSelectionChanged</span> <span class="token punctuation">(</span>newSelection<span class="token operator">:</span> SENodule<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
</code></pre></div><p>This method then checks to see if there are any style changes that need to be stored in the command stack so they can be undone later. If there is a non-empty selection, the <code>initialStyleState</code> and <code>defaultStyleState</code> of the selected objects (for front and back) is recorded in these variables in the Vuex store. These are keep in the store because there are Vue <span class="component">ColorSelector</span> and <span class="component">NumberSelector</span> components across <em>two</em> expansion panels that need access these variables to set the state of their selectors.</p> <div class="language-vue extra-class"><pre class="language-vue"><code>this.$store.direct.commit.recordStyleState({
  selected: newSelection,
  backContrast: Nodule.getBackStyleContrast()
});</code></pre></div><p>Upon <span class="method">setXXXSelectorState()</span> method being executed, the program first determines if all the selected objects have style XXX (via the <span class="method">hasXXX()</span>). If they, do the <span class="component">fade-in-card</span> is display for that style, if not it is not displayed. If the style is common to all selected objects, the program then check to see if the value of that style is the same across all selected objects. If it is not, the <span class="variable">XXXAgreement</span> variable is set to <span class="component">false</span> and a button saying &quot;Differing Styles Detected -- Override&quot; is displayed. If the user clicks that button, the <span class="variable">XXXAgreement</span> variable is set to <span class="component">true</span> and any style selection will set that one style property of all selected objects to be the same. Once a selection is made the <span class="button">Undo</span> button is activative, and by clicking it all selected objects will revert that style property back to the style they had when they were <em>selected</em>. Clicking the <span class="button">Apply Defaults</span> button will revert the selected objects back to their default style.</p> <p>The big picture idea is that to update the display of an object. The</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">updateStyle</span><span class="token punctuation">(</span>options<span class="token operator">:</span> StyleOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
</code></pre></div><p>method records the new style choices in the variables of the plottable class. Then the</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stylize</span><span class="token punctuation">(</span>DisplayStyle<span class="token punctuation">.</span><span class="token constant">APPLYCURRENTVARIABLES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">adjustSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>commands apply the newly updated variables to the actual TwoJS objects so that they are rendered to the screen. This way the current style state of the plottable is readable with the</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">currentStyleState</span><span class="token punctuation">(</span>front<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> StyleOptions <span class="token punctuation">{</span>
</code></pre></div><p>method which returns the current value of each style variable.</p> <p>The background panel has slightly different options because of the <span class="variable">dynamicBackStyle</span> variable. When this variable is set many of the styles for the back side display are automatically calculated based on the value of <span class="variable">Nodule.backStyleContrast</span> variable (always between 0 and 1) and the methods</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">static</span> <span class="token function">contrastFillColor</span><span class="token punctuation">(</span>frontColor<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
<span class="token keyword">static</span> <span class="token function">contrastStrokeColor</span><span class="token punctuation">(</span>frontColor<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
<span class="token keyword">static</span> <span class="token function">contrastOpacity</span><span class="token punctuation">(</span>frontOpacity<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
<span class="token keyword">static</span> <span class="token function">contrastStrokeWidthPercent</span><span class="token punctuation">(</span>frontPercent<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
<span class="token keyword">static</span> <span class="token function">contrastPointRadiusPercent</span><span class="token punctuation">(</span>frontPercent<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span>
</code></pre></div><p>found in the <span class="class">Nodule</span> class. The idea is that if <span class="variable">Nodule.backStyleContrast</span> is equal to one there is essentially no difference between front and back styling and if equal to zero almost nothing appears on back of sphere for colors and size reduction is maximized. The background panel always displays a slider for adjusting <span class="variable">Nodule.backStyleContrast</span> and the results are automatically displayed on the screen in real time. The other option is the enable/disable the <span class="variable">dynamicBackStyle</span> for the selected objects (each object has its own copy of the <span class="variable">dynamicBackStyle</span> variable). If <span class="variable">dynamicBackStyle</span> is true, the only way to adjust the styling (except for dash pattern) is via the <span class="variable">Nodule.backStyleContrast</span> slider. If <span class="variable">dynamicBackStyle</span> is false, then the common style for the selected objects is adjustable with the styling options that appear.</p> <h2 id="languages"><a href="#languages" class="header-anchor">#</a> Languages</h2> <p>Spherical Easel uses the <a href="https://kazupon.github.io/vue-i18n/api/#extension-of-vue" target="_blank" rel="noopener noreferrer">Vue I18n internationalization plugin for Vue.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. If you are interested in helping translate this program into another language, please (TODO: add a link)</p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tools/edit.html" class="prev">
        Edit Tools
      </a></span> <span class="next"><a href="/design/handlers/">
        Event Handlers
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.dbe54ffb.js" defer></script><script src="/assets/js/2.3e5ec5bd.js" defer></script><script src="/assets/js/22.17040f51.js" defer></script><script src="/assets/js/4.6a2b2572.js" defer></script>
  </body>
</html>
